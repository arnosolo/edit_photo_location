<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
        <title>为照片添加位置</title>
        <link rel="stylesheet" href="./bootstrap.min.css">
        <style type="text/css">
            .map {
                width: 100%;
                height: 400px;
                /* float: left; */
            }

            /* #preview {
                width: 150px;
            } */

            a:link {color: black; text-decoration:none;}

        </style>
    </head>

    <script src="https://webapi.amap.com/loader.js"></script>
    <script src="./js/piexif.js"></script>
    <script src="./js/coordinate_converter.js"></script>
    <script type="text/javascript" >
        /* 定义一些变量 */
        // 存放 地图上选择的点
        var globalPosition = []
        // 存放 输入的文件
        var files = []

        window.onload = function(){
            // 加载地图
            AMapLoader.load({
                "key": "9c5c51916fc0a4e7e2cf745fb39ffe2c",              // 申请好的Web端开发者Key，首次调用 load 时必填
                "version": "1.4.15",   // 指定要加载的 JSAPI 的版本，缺省时默认为 1.4.15
                "plugins": [],           // 需要使用的的插件列表，如比例尺'AMap.Scale'等
                "AMapUI": {             // 是否加载 AMapUI，缺省不加载
                    "version": '1.1',   // AMapUI 缺省 1.1
                    "plugins":['overlay/SimpleMarker'],       // 需要加载的 AMapUI ui插件
                },
                "Loca":{                // 是否加载 Loca， 缺省不加载
                    "version": '1.3.2'  // Loca 版本，缺省 1.3.2
                },
            }).then((AMap)=>{
                    var map = new AMap.Map('container');

                    //加载PositionPicker，loadUI的路径参数为模块名中 'ui/' 之后的部分
                    AMapUI.loadUI(['misc/PositionPicker'], function(PositionPicker) {
                        var map = new AMap.Map('container',{
                            zoom:16
                        })
                        var positionPicker = new PositionPicker({
                            mode:'dragMap',//设定为拖拽地图模式，可选'dragMap'、'dragMarker'，默认为'dragMap'
                            map:map//依赖地图对象
                        });
                        //TODO:事件绑定、结果处理等
                        positionPicker.on('success', function(positionResult) {
                            // document.getElementById('lnglat').innerHTML = positionResult.position;
                            document.getElementById('address').innerHTML = positionResult.address;
                            var {lng,lat} = positionResult.position
                            // console.log(positionResult);
                            // 在全局中记录选定的坐标
                            var converted = gcj02towgs84(lng,lat)
                            // document.getElementById('converted').innerHTML = converted;
                            // console.log(converted);
                            globalPosition = converted
                        });

                        positionPicker.start();
                    });

                }).catch((e)=>{
                    console.error(e);  //加载错误提示
                });
        };

        /* 函数: 
            - 修改文件对象
            - 修改预览图片
            - 把下载按钮的信息改为等待完成
            */
        function newInput (target) {
            // 修改文件对象
            files = document.getElementById('file-input').files;
            // console.log(file) // 有文件名,大小,修改时间

            // 读取文件
            var reader = new FileReader()
            reader.readAsDataURL(files[0])
            reader.onload = function (e) {
                // 修改预览图片
                document.getElementById('preview').src = e.target.result
            }

            // 把下载按钮的信息改为等待完成
            var downloadBtn = document.getElementById('download-btn')
            downloadBtn.href = 'javascript:;'
            downloadBtn.innerText = "等待下载"
            downloadBtn.download = 'empty'
        }

        /* 函数: 修改元数据 */
        function modifyExif(params) {
            //获取读取我文件的File对象
            var reader = new FileReader()
            reader.readAsDataURL(files[0])
            reader.onload = function (e) {
                // 获取原来的元数据信息
                const oldExifObj = piexif.load(e.target.result);
                console.log('oldExifObj:');
                console.log(oldExifObj);

                // gps由十进制值改为分度值
                const lng = globalPosition[0]
                const lat = globalPosition[1]
                // 将对象复制一份,避免修改原来对象中的数据
                var exifObj = JSON.parse(JSON.stringify(oldExifObj))
                // var exifObj = oldExifObj
                exifObj.GPS[piexif.GPSIFD.GPSLatitudeRef] = lat < 0 ? 'S' : 'N';
                exifObj.GPS[piexif.GPSIFD.GPSLatitude] = piexif.GPSHelper.degToDmsRational(lat);
                exifObj.GPS[piexif.GPSIFD.GPSLongitudeRef] = lng < 0 ? 'W' : 'E';
                exifObj.GPS[piexif.GPSIFD.GPSLongitude] = piexif.GPSHelper.degToDmsRational(lng);    
                // 将修改后的信息成二进制信息
                // console.log(exifObj);
                var exifbytes = piexif.dump(exifObj)
                // 注入二进制元数据,返回注入后的图片对象
                var inserted = piexif.insert(exifbytes, e.target.result)

                // 查看修改后的信息
                const newExifObj = piexif.load(inserted);
                console.log('newExifObj');
                console.log(newExifObj);

                var downloadBtn = document.getElementById('download-btn')
                downloadBtn.href = inserted
                downloadBtn.innerText = "已添加位置信息,请下载"
                downloadBtn.download = files[0].name

            }
        }
             
        /* 这个函数用于隐藏那个无法改变尺寸的input按钮 */
        function addfile() {
    　　　　document.getElementById("file-input").click();
    　　　}

    </script>


    <body>
        <h3 align="center">为照片添加位置信息</h3>
        <div class="row">
            <div class="col-sm">
                <div class="card" >
                    <img src="./img/transparent1.png" class="card-img-top" alt="..." id="preview">
                    <div class="card-body">
                        <h5 class="card-title">1 选择照片</h5>
                        <!-- <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p> -->
                        <a href="#" class="btn btn-light" onclick="addfile()">
                            点我选择照片
                            <input id="file-input" 
                            type="file" 
                            onchange="newInput()" 
                            style="display:none"
                            />
                        </a>
                    </div>
                </div>
                
                <!-- <div class="container"> -->
                <!-- <h4>1 选择照片</h4>
                    <button onclick="addfile()" class="btn btn-light">点我选择照片</button>    
                    <input id="file-input" 
                        type="file" 
                        onchange="newInput()" 
                        style="display:none"
                    />
                    <img src="./img/transparent.png" alt="preview" class="img-thumbnail img-fluid" id="preview"> -->
            </div>

                <div class="col-sm-6">
                    <div class="card">
                        <!-- <img src="" class="card-img-top" alt="..."> -->
                        <div class="card-img-top map" id="container"></div>
                        <div class="card-body">
                            <h5 class="card-title">2 拖拽地图以选择位置</h5>
                            <p class="card-text" id='address'>地址</p>
                            <a href="#" class="btn btn-light">
                                <button id="confirm-btn" onclick="modifyExif()">确认使用当前位置</button>
                            </a>
                        </div>
                    </div>
                    <!-- <h4>2 拖拽地图以选择位置</h4>
                    <div>地址:</div>
                    <div id='address'>address</div> -->
                        <!-- <div>经纬度:</div>
                        <div id='lnglat'>lnglat</div> -->
                        <!-- <div>转化到gps坐标系:</div>
                        <div id='converted''>address </div> -->
                    <!-- <div id="container" class="map"></div>
                    <button id="confirm-btn" onclick="modifyExif()" 
                        class="btn btn-light">确认使用当前位置</button> -->
                </div>

                <div class="col-sm">
                    <div class="card">
                        <div class="card-body">
                          <h5 class="card-title">3 下载照片</h5>
                          <!-- <p class="card-text">With supporting text below as a natural lead-in to additional content.</p> -->
                          <a href="#" class="btn btn-light" 
                            id='download-btn' download="photo.jpg">等待编辑完成</a>
                        </div>
                    </div>
                    <!-- <h4>3 下载照片</h4>
                    <button class="btn btn-light">
                        <a href="javascript:;" id='download-btn' download="photo.jpg">等待编辑完成</a>
                    </button> -->
                </div>

            </div>
          </div>

        <br><br><br><br>
        <a href="mailto:arno756@outlook.com" style="font-size: medium;">联系作者</a>
        <br><br><br><br>

    </body>

</html>       